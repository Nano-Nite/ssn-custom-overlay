<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Overlay (Lite)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    @font-face {
        font-family: 'Arima-Regular';
        src: url('https://raw.githubusercontent.com/NDISCOVER/Arima-Font/master/fonts/static/ttf/Arima-Regular.ttf')
         format('truetype');
        font-weight: 300;
        font-style: normal;
        font-size: large;
    }

    body,html{
        margin:0;padding:0;width:auto;height:auto;
        background:transparent;overflow:hidden;
        font-family:'Arima-Regular',sans-serif;
    }

    #chat {
        position:absolute;
        left:50%;bottom:0;
        transform:translateX(-50%);
        width:100%;max-width:350px;
        padding:0 20px;
        box-sizing:border-box;
    }

    .msg {
        background:#edebeb;
        /* border:1px solid #2e3b55; */
        /* border-left:4px solid #4ab8f9; */
        color:black;
        padding:12px;
        margin-bottom:12px;
        border-radius:12px;
        opacity:0;
        transform:translateY(20px);
        transition:0.45s ease;
    }

    .msg.visible{
        opacity:1;
        transform:translateY(0);
    }

    .fade-out{
        opacity:0 !important;
    }

    .avatar{
        width:40px;height:40px;
        border-radius:50%;background-size:cover;
        margin-right:10px;flex-shrink:0;
    }

    .row{display:flex;align-items:center;}
    .name{font-weight:700;font-size:1em;}
    .text{margin-top:6px;font-size:.9em;line-height:1.4;}
</style>
</head>

<body>
<div id="chat"></div>

<script>
const MAX_MESSAGES = 1;
const chat = document.getElementById("chat");

document.addEventListener("click", () => {
    const snd = document.getElementById("notifSound");
    if (snd) snd.play().then(() => snd.pause());
}, { once: true });


function addMessage(d){
    if(!d.chatname && !d.chatmessage) return;

    // Play notification audio
    const snd = document.getElementById("notifSound");
    if (snd) {
        snd.volume = 0.3;
        snd.currentTime = 0;

        snd.play().catch(err => {
            console.log("Audio blocked, waiting for user interaction:", err);
        });
    }


    const div = document.createElement("div");
    div.className="msg";

    const avatar = d.chatimg
        ? `<div class="avatar" style="background-image:url('${d.chatimg}')"></div>`
        : "";

    div.innerHTML = `
        <div class="row">
            ${avatar}
            <div class="name">${d.chatname || ""}</div>
        </div>
        <div class="text">${d.chatmessage || ""}</div>
    `;

    chat.appendChild(div);

    // trigger animation
    requestAnimationFrame(()=>div.classList.add("visible"));

    // fade out after 25s
    setTimeout(()=>div.classList.add("fade-out"), 10000);

    // remove after fade (33s)
    setTimeout(()=>{
        if(div.parentNode) div.parentNode.removeChild(div);
    }, 15000);

    // Keep message count small
    const msgs = chat.querySelectorAll(".msg");
    if(msgs.length > MAX_MESSAGES){
        // msgs[0].remove();
        const old = msgs[0];
        // fade out animation
        old.classList.add("fade-out");

        // remove after animation finishes (0.5s)
        setTimeout(() => {
            if (old.parentNode) old.remove();
        }, 500);
    }
}

// --- Social Stream Ninja Integration ---
var urlParams = new URLSearchParams(window.location.search);
var roomID = urlParams.get("session") || "iWWnKL28tQ";
var password = "false";

var iframe = document.createElement("iframe");
iframe.src = "https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password="+password+"&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room="+roomID;
iframe.style = "width:0;height:0;position:fixed;left:-100px;top:-100px;";
document.body.appendChild(iframe);

window.addEventListener("message", e=>{
    if(e.source !== iframe.contentWindow) return;
    const data = e.data?.dataReceived?.overlayNinja;
    if(data) addMessage(data);
});

// Optional WebSocket listener
if(urlParams.has("server")){
    const socket = new WebSocket(urlParams.get("server"));
    socket.onmessage = e=>{
        try{ addMessage(JSON.parse(e.data)); }catch{}
    };
}
</script>
<!-- <audio id="notifSound" src="new-notification-014-363678.mp3" preload="auto"></audio> -->
<!-- <audio id="notifSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_6ddc926bb4.mp3" preload="auto"></audio> -->
</body>
</html>
